---
title: "Lower Basin Projected Water Use: 2025 - 2027"
subtitle: "April 2025: Probable Maximum 24-Month Study"
format:
  docx:
    mainfont: Arial # Sets the main font to Arial for Word output
    reference-doc: custom-reference-doc.docx # Use template
---

```{r setup, include=FALSE}
# This chunk is for global R options and loading packages
# Set echo=FALSE to hide code, warning=FALSE to hide warnings, message=FALSE to hide messages
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse) # To use tidyverse functions
library(knitr)     # For kable tables
library(readxl)

source("helper-functions.R")

##### Update file paths ######################
file_path <- "data/Projected State Use -APR25.xlsx"

# file path for the Water Use Assumption SCT export excel file
file_path2 <- "data/APR25-Max.xlsx"

# Update sheet name and data range for the Water Use Assumption SCT export
sheet_name4 <- "Sheet1"
data_range4 <- "A1:E49"
##############################################

## There sheet names and data ranges (for Projected State Use) should not be changed.
sheet_name1 <- as.character(year(Sys.Date()))
sheet_name2 <- as.character(year(Sys.Date())+1)
sheet_name3 <- as.character(year(Sys.Date())+2)
data_range1 <- "A1:D58" # MOST Data range
data_range2 <- "F1:I58" # MIN Data range
data_range3 <- "K1:N58" # MAX Data range
# Conservation data ranges
rangeCA = "AH4:AM20"
rangeNonCAWCD = "Z4:AE20"
rangeCAWCD = "R4:W20"

sheet_cons = "System Conservation"

#####################################################################


# Read MAX data
#Current Year
Max1 <- process_excel_data(file_path, sheet_name1, data_range3)

#First Out year
Max2 <- process_excel_data(file_path, sheet_name2, data_range3)

#Second Out Year
Max3 <- process_excel_data(file_path, sheet_name3, data_range3)

# Get SCT data
if (!file.exists(file_path2)) {
  stop(paste("Error: The file was not found at the specified path:", file_path2))
}

sct_data <- read_excel(path = file_path2, sheet = sheet_name4, range = data_range4)

sct_data <- sct_data[, -2]

if (ncol(sct_data) == 4) {
  # Get the current year
  current_year <- year(Sys.Date()) # Using lubridate's year() function
  
  # Define the new column names
  new_column_names <- c(
    "Item",
    paste0("CY", current_year),
    paste0("CY", current_year + 1),
    paste0("CY", current_year + 2)
  )
  
  # Assign the new names to excel_data2
  names(sct_data) <- new_column_names
  
} else {
  warning(paste("Warning: sct_data does not have the expected 4 columns after deletion. It has", 
                ncol(sct_data), "columns. Column renaming might be incorrect."))
}

apportionment <- sct_data %>% 
  filter(
    str_detect(Item,
               regex(
                 "California_Apportionment|.AzTotalAnnual|.NvTotalAnnual"
                 )
               )
    ) 

#round(sum(apportionment[,2])/1000000,3)

mwdICSY1 = ifelse(find_rows_containing_string(sct_data,"MWD_Default")[1,2],
               paste0("creation of ", 
                      round(find_rows_containing_string(sct_data,"MWD_Default")[1,2]/1000,1)),
               paste0("delivery of ", 
                      round(find_rows_containing_string(sct_data,"MWD_Default")[2,2]/1000,1)))

mwdICSY2 = ifelse(find_rows_containing_string(sct_data,"MWD_Default")[1,3],
               paste0("creation of ", 
                      round(find_rows_containing_string(sct_data,"MWD_Default")[1,3]/1000,1)),
               paste0("delivery of ", 
                      round(find_rows_containing_string(sct_data,"MWD_Default")[2,3]/1000,1)))

mwdICSY3 = ifelse(find_rows_containing_string(sct_data,"MWD_Default")[1,4],
               paste0("creation of ", 
                      round(find_rows_containing_string(sct_data,"MWD_Default")[1,4]/1000,1)),
               paste0("delivery of ", 
                      round(find_rows_containing_string(sct_data,"MWD_Default")[2,4]/1000,1)))

###### Check for AZ Reductions ######################

# x <- find_rows_containing_string(sct_data, "CAP Annual Shortage Volume")[2] 
# y <- find_rows_containing_string(sct_data, "AnnualDCPContribution_AZ")[2]
# z <- find_rows_containing_string(sct_data, "AnnualDeliveryEC_AZ")[2]
# condition1_met <- x > 0; 
# condition2_met <- y > 0; 
# condition3_met <- z > 0
# 
# if(x >0 | y>0 | z>0){
#   addreductions = TRUE
# } else {
#   addreductions = FALSE
# }
# 
# # --- Define the phrases for each condition ---
# phrase1_text <- paste0("Shortage volume of ", round(x/1000,0), " kaf")
# phrase2_text <- paste0("DCP contribution of ", round(y/1000,0), " kaf")
# phrase3_text <- paste0("ICS delivery of ", round(z/1000,0), " kaf")
# 
# active_phrases <- character(0)
# if (condition1_met) { active_phrases <- c(active_phrases, phrase1_text) }
# if (condition2_met) { active_phrases <- c(active_phrases, phrase2_text) }
# if (condition3_met) { active_phrases <- c(active_phrases, phrase3_text) }
# num_active_conditions <- length(active_phrases)
# reductions_scen_all <- ""
# if (num_active_conditions == 1) { reductions_scen_all <- active_phrases[1]
# } else if (num_active_conditions == 2) { reductions_scen_all <- paste0(active_phrases[1], ", and ", active_phrases[2])
# } else if (num_active_conditions == 3) { reductions_scen_all <- paste0(active_phrases[1], ", ", active_phrases[2], ", and ", active_phrases[3])}


#####################################################





cons_CA <- tryCatch({
  readxl::read_excel(path = file_path, sheet = sheet_cons, range = rangeCA)
}, error = function(e) {
  stop(paste("Error reading Excel file:", e$message))
  return(NULL) # Should not reach here due to stop()
})

cons_CA <- remove_all_na_rows(cons_CA)

cons_NonCAWCD <- tryCatch({
  readxl::read_excel(path = file_path, sheet = sheet_cons, range = rangeNonCAWCD)
}, error = function(e) {
  stop(paste("Error reading Excel file:", e$message))
  return(NULL) # Should not reach here due to stop()
})

cons_NonCAWCD <- remove_all_na_rows(cons_NonCAWCD)
#remove 242
cons_NonCAWCD_filt <- cons_NonCAWCD %>% 
  slice_head(n = -1)
cons_NonCAWCD_tot <- cons_NonCAWCD %>% 
  slice_head(n = -1) %>% 
  summarise(across(where(is.numeric), \(x) sum(x, na.rm = TRUE))) 

cons_CAWCD <- tryCatch({
  readxl::read_excel(path = file_path, sheet = sheet_cons, range = rangeCAWCD)
}, error = function(e) {
  stop(paste("Error reading Excel file:", e$message))
  return(NULL) # Should not reach here due to stop()
})

cons_CAWCD_tot <- cons_CAWCD %>% 
  summarise(across(where(is.numeric), \(x) sum(x, na.rm = TRUE)))

current_year <- format(Sys.Date(), "%Y")
column_number <- which(grepl(current_year, colnames(cons_NonCAWCD)))



text_to_exclude = "CVWD"
cons_CA_filt <- cons_CA %>%
  filter(is.na(Contractor) | !str_detect(Contractor, fixed(text_to_exclude)))

cvwd <- find_rows_containing_string(cons_CA, text_to_exclude)
new_item <- c("Contractor" = "CVWD")
new_item <- c(new_item, colSums(cvwd[,2:ncol(cvwd)]))

cons_CA_filt <- cons_CA %>%
  filter(is.na(Contractor) | !str_detect(Contractor, fixed(text_to_exclude)))

cons_CA_filt <- rbind(tibble::as_tibble(as.list(new_item)), cons_CA_filt)

name_lookup <- c(
  "IID 2023-2026" = "IID",
  "GM Gabrych/Matador" = "Gabrych",
  "Metro Water Dist" = "Metro Water District",
  "Spanish Trail Water Company" = "Spanish Trail Water Co."
)

updated_cons_CA_filt <- replace_items_conditional(cons_CA_filt , name_lookup)

cons_CA_CY <- updated_cons_CA_filt %>% 
  filter(.[[column_number]] > 0) %>% 
  select(1,all_of(column_number))

cons_CA_CY2 <- updated_cons_CA_filt %>% 
  filter(.[[column_number+1]] > 0) %>% 
  select(1,all_of(column_number+1))

cons_CA_CY3 <- updated_cons_CA_filt %>% 
  filter(.[[column_number+2]] > 0) %>% 
  select(1,all_of(column_number+2))

cons_CAWCD <- remove_all_na_rows(cons_CAWCD)

cons_CAWCD_CY <- replace_items_conditional(cons_CAWCD, name_lookup) %>% 
  filter(.[[column_number]] > 0) %>% 
  select(1,all_of(column_number))

cons_NonCAWCD_CY <- cons_NonCAWCD_filt %>% 
  replace_items_conditional(name_lookup) %>% 
  filter(.[[column_number]] > 0) %>% 
  select(1,all_of(column_number))

cons_CAWCD_CY2 <- replace_items_conditional(cons_CAWCD, name_lookup) %>% 
  filter(.[[column_number+1]] > 0) %>% 
  select(1,all_of(column_number+1))

cons_NonCAWCD_CY2 <- cons_NonCAWCD_filt %>% 
  replace_items_conditional(name_lookup) %>% 
  filter(.[[column_number+1]] > 0) %>% 
  select(1,all_of(column_number+1))

cons_CAWCD_CY3 <- replace_items_conditional(cons_CAWCD, name_lookup) %>% 
  filter(.[[column_number+2]] > 0) %>% 
  select(1,all_of(column_number+2))

cons_NonCAWCD_CY3 <- cons_NonCAWCD_filt %>% 
  replace_items_conditional(name_lookup) %>% 
  filter(.[[column_number+2]] > 0) %>% 
  select(1,all_of(column_number+2))

# Example condition for conditional Markdown
# Replace this with your actual condition
show_2025_detailed_note <- FALSE 
# show_2025_detailed_note <- (a == 3) # Another example condition

```

### `r current_year`

Total projected water use **(`r sprintf("%.3f",round(as.numeric(find_rows_containing_string(Max1,"Total Basin Use")$value)/1000000,3))` maf)** – Based on Lake Mead Operating Condition of Level 1 Shortage and water savings contributions under the LB DCP Agreement and IBWC Minute 323.

```{r conditional-2025-note, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if (exists("show_2025_detailed_note") && show_2025_detailed_note) {
  cat("\n") # Ensures a new line before the conditional text
  cat("**Important Note for 2025:** *This text is included based on an R condition.*\n")
  cat("You can include any valid Markdown here, like:\n")
  cat("- Bullet points\n")
  cat("- **Bold text** or *italic text*\n")
  cat("> Blockquotes\n")
}
```

#### U.S. Contractors: `r sprintf("%.3f",round(sum(apportionment[,2])/1000000,3))` maf

##### California: `r sprintf("%.3f",round(sum(apportionment[1,2])/1000000,3))` maf
* MWD annual diversion of `r round(as.numeric(find_rows_containing_string(sct_data,"MWDDiversionAnnualFC")[2])/1000,0)` kaf
    * Projected diversion includes the `r mwdICSY1` kaf of ICS

```{r generate-bullet-list-apply, results='asis'}
# Check if cons_CA_CY has rows and at least two columns before proceeding
if (nrow(cons_CA_CY) > 0 && ncol(cons_CA_CY) >= 2) {
  cat("* Total California System Conservation of ")
  cat(sprintf("%.1f",round(sum(cons_CA[,column_number])/1000,1)))
  cat(" kaf\n")
  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_CA_CY, 1, function(row) {
    paste0("  * ", row[1], " system conservation of ", round(as.numeric(row[2])/1000,1) , " kaf\n")
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
}

```

* Needles PSCP volume of `r as.numeric(find_rows_containing_string(Max1, "Needles")$value)*-1` af
```{r conditional-CA-BICS-Y1, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "AnnualCreationBiNat_MWD")[1,2]>0){
  addBICS = TRUE
  bics = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationBiNat_MWD")[1,2]/1000,1)))
} else{
  addBICS = FALSE
  bics=""
}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by MWD and IID\n")
}


```

##### Arizona: `r sprintf("%.3f",round(sum(apportionment[2,2])/1000000,3))` maf
* CAP annual diversion of `r round(find_rows_containing_string(sct_data, "CAPAnnualFC")[1,2]/1000,0)` kaf

```{r conditional-AZ-reductions-Y1, results='asis', echo=FALSE}

addreductions = calculate_AZ_reductions(year=1, sct_data = sct_data)$addreductions
reductions_scen_all = calculate_AZ_reductions(year=1, sct_data = sct_data)$reductions_scen_all

if (exists("addreductions") && addreductions) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("    * Projected diversion includes a ")
  cat(reductions_scen_all)
  cat("\n")
}

az_dcpICS <- find_rows_containing_string(sct_data, "AnnualCreationDCP_CAWCD")[2]
az_dcpICS <- ifelse((az_dcpICS/1000) %% 1 != 0, round(az_dcpICS/1000, 1), round(az_dcpICS/1000, 0))
az_dcpSys <- find_rows_containing_string(sct_data, "AnnualSysWaterforDCP_CAWCD")[2]
az_dcpSys <- ifelse((az_dcpSys/1000) %% 1 != 0, round(az_dcpSys/1000, 1), round(az_dcpSys/1000, 0))

```

* DCP contribution will be made by creating `r ifelse(az_dcpICS > 0, paste0(az_dcpICS, " kaf of ICS and ", az_dcpSys, " kaf of non-ICS water"), paste0(az_dcpSys, " kaf of non-ICS water"))` 
* Total non-CAWCD System Conservation of `r sprintf("%.1f",round(sum(cons_NonCAWCD_filt[,column_number])/1000,1))` kaf
```{r generate-bullet-list-nonCAWCD-y1, results='asis'}
# Check if cons_CA_CY has rows and at least two columns before proceeding
if (nrow(cons_NonCAWCD_CY) > 0 && ncol(cons_NonCAWCD_CY) >= 2) {

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_NonCAWCD_CY, 1, function(row) {
    paste0("  * ", row[1], " : ", ifelse(as.numeric(row[2])>100, paste0(round(as.numeric(row[2])/1000,1) , " kaf\n"), paste0(round(as.numeric(row[2]),0), " af\n") ))
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} else if (nrow(cons_NonCAWCD_CY) == 0) {
  cat("No data available in `cons_NonCAWCD_CY` to create a list.")
} else {
  cat("`cons_NonCAWCD_CY` does not have at least two columns as expected.")
}
```

* Total CAWCD System Conservation of `r sprintf("%.1f",round(sum(cons_CAWCD[,column_number])/1000,1))` kaf

```{r generate-bullet-list-CAWCD-Y1, results='asis'}
# Check if cons_CA_CY has rows and at least two columns before proceeding
if (nrow(cons_CAWCD_CY) > 0 && ncol(cons_CAWCD_CY) >= 2) {

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_CAWCD_CY, 1, function(row) {
    paste0("  * ", row[1], " : ", ifelse(as.numeric(row[2])>100, paste0(round(as.numeric(row[2])/1000,1) , " kaf\n"), paste0(round(as.numeric(row[2]),0), " af\n") ))
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} else if (nrow(cons_CAWCD_CY) == 0) {
  cat("No data available in `cons_CAWCD_CY` to create a list.")
} else {
  cat("`cons_CAWCD_CY` does not have at least two columns as expected.")
}


```

* Bullhead City PSCP volume of `r as.numeric(find_rows_containing_string(Max1, "BHC")$value)*-1` af

```{r conditional-AZ-242-Y1, results='asis', echo=FALSE}

if(find_rows_containing_string(cons_NonCAWCD,"242 Wellfield")[,column_number]>0){
  add242 = TRUE
  vol242 = sprintf("%.1f",round(find_rows_containing_string(cons_NonCAWCD,"242 Wellfield")[,column_number]/1000,1))
} else{
  add242 = FALSE
  vol242=""
}

if (exists("add242") && add242) {
  
  cat("* System water created by the 242 Well Field Expansion Project of ")
  cat(vol242)
  cat(" kaf\n")
}

```


```{r conditional-AZ-BICS-Y1, results='asis', echo=FALSE}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by CAWCD\n")
}

```

##### Nevada: `r sprintf("%.3f",round(sum(apportionment[3,2])/1000000,3))` maf
* SNWA annual use of `r round(find_rows_containing_string(sct_data, "NvTotalAnnual")[1,2]/1000,0)` kaf. Projected diversion includes:

```{r conditional-NV-Shortage, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "SNWP Annual Shortage Volume")[1,2]>0){
  addNVShortage = TRUE
  nvshort = unlist(unname(round(find_rows_containing_string(sct_data, "SNWP Annual Shortage Volume")[1,2]/1000,0)))
} else{
  addNVShortage = FALSE
  nvshort=""
}

if(find_rows_containing_string(sct_data, "VacatedECICSToBeDelivered_SNWA")[1,2]>0){
  addECICSdel = TRUE
  nvECICSdel = unlist(unname(round(find_rows_containing_string(sct_data, "VacatedECICSToBeDelivered_SNWA")[1,2]/1000,1)))
} else{
  addECICSdel = FALSE
  nvECICSdel=""
}

if (exists("addNVShortage") && addNVShortage) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Shortage volume of ")
  cat(nvshort)
  cat(" kaf\n")
}

if (exists("addECICSdel") && addECICSdel) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Delivery of ")
  cat(nvECICSdel)
  cat(" kaf of EC ICS due to full ICS bank\n")
}

```


```{r conditional-NV-DCP, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "AnnualCreationDCP_NV")[1,2]>0){
  addNVDCP = TRUE
  nvdcp = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationDCP_NV")[1,2]/1000,0)))
} else{
  addNVDCP = FALSE
  nvdcp=""
}

if (exists("addNVDCP") && addNVDCP) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("* DCP contribution of ")
  cat(nvdcp)
  cat(" kaf through EC ICS conversion\n")
}


```


```{r conditional-NV-SysCons, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "NV_SystemConservation")[1,2]>0){
  addNVTotSyscon = TRUE
  nvTotSyscon = unlist(unname(round(find_rows_containing_string(sct_data, "NV_SystemConservation")[1,2]/1000,0)))
} else{
  addNVTotSyscon = FALSE
  nvTotSyscon=""
}

if(find_rows_containing_string(sct_data, "NV_LeftinMead")[1,2]>0){
  addTribSyscon = TRUE
  nvTribSyscon = unlist(unname(round(find_rows_containing_string(sct_data, "NV_LeftinMead")[1,2]/1000,0)))
} else{
  addTribSyscon = FALSE
  nvTribSyscon=""
}


if (exists("addNVTotSyscon") && addNVTotSyscon) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("* Total System Conservation of ")
  cat(nvTotSyscon)
  cat(" kaf\n")
}

if (exists("addTribSyscon") && addTribSyscon) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Tributary conservation of ")
  cat(nvTribSyscon)
  cat(" kaf\n")
}

if(addNVTotSyscon && addTribSyscon) {
  if((nvTotSyscon - nvTribSyscon)>0){
    cat("  * Other system conservation of ")
    cat(nvTotSyscon - nvTribSyscon)
    cat(" kaf\n")
  }
}


```

```{r conditional-NV-BICS-Y1, results='asis', echo=FALSE}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by SNWA\n")
}

```

#### Mexico’s Scheduled Water Delivery: `r sprintf("%.3f", round(as.numeric(find_rows_containing_string(Max1, "Mexico Use")$value)/1000000,3))` maf

```{r conditional-Mx-short-Y1, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "Mexico Annual Shortage")[1,2]>0){
  addMxShort = TRUE
  mxShort = unlist(unname(round(find_rows_containing_string(sct_data, "Mexico Annual Shortage")[1,2]/1000,0)))
} else{
  addMxShort = FALSE
  mxShort=""
}

if(find_rows_containing_string(sct_data, "AnnualCreationMXRecoverableWaterSavings")[1,2]>0){
  createWaterSav = TRUE
  mxCreateWaterSav = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationMXRecoverableWaterSavings")[1,2]/1000,0)))
} else{
  createWaterSav = FALSE
  mxCreateWaterSav=""
}

if(find_rows_containing_string(sct_data, "AnnualDeliveryMXRecoverableWaterSavings")[1,2]>0){
  delWaterSav = TRUE
  mxdelWaterSav = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualDeliveryMXRecoverableWaterSavings")[1,2]/1000,0)))
} else{
  delWaterSav = FALSE
  mxdelWaterSav=""
}

if(find_rows_containing_string(sct_data, "MX_SystemConservation")[1,2]>0){
  createsysCons = TRUE
  mxSysCon = unlist(unname(round(find_rows_containing_string(sct_data, "MX_SystemConservation")[1,2]/1000,1)))
} else{
  createsysCons = FALSE
  mxSysCon=""
}

if(find_rows_containing_string(sct_data, "AnnualDeliveryMexicoWaterReserve")[1,2]>0){
  delMWR = TRUE
  mxdelMWR = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualDeliveryMexicoWaterReserve")[1,2]/1000,1)))
} else{
  delMWR = FALSE
  mxdelMWR=""
}

if(find_rows_containing_string(sct_data, "AnnualCreationMexicoWaterReserve")[1,2]>0){
  createMWR = TRUE
  mxcreateMWR = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationMexicoWaterReserve")[1,2]/1000,1)))
} else{
  createMWR = FALSE
  mxcreateMWR=""
}

if (exists("createWaterSav") && createWaterSav) {
  cat("* Projected delivery includes:\n")
  
  if (exists("addMxShort") && addMxShort) {
    cat("  * Shortage volume of ")
    cat(mxShort)
    cat(" kaf\n")
  }
  
  cat("  * Recoverable Water Savings Contribution of ")
  cat(mxCreateWaterSav)
  cat(" kaf\n")
  
  if (exists("delWaterSav") && delWaterSav) {
    cat("  * Recoverable Water Savings Delivery of ")
    cat(mxdelWaterSav)
    cat(" kaf\n")
  }
  
  if (exists("createsysCons") && createsysCons) {
    cat("  * Minute 330 System Conservation of ")
    cat(mxSysCon)
    cat(" kaf\n")
  }
  
  if (exists("delMWR") && delMWR) {
    cat("* Water Reserve delivery of ")
    cat(mxdelMWR)
    cat(" kaf\n")
  }
  
  if (exists("createMWR") && createMWR) {
    cat("* Water Reserve creation of ")
    cat(mxcreateMWR)
    cat(" kaf\n")
  }
}

```


### `r as.numeric(current_year) + 1`

Total projected water use **(`r sprintf("%.3f",round(as.numeric(find_rows_containing_string(Max2,"Total Basin Use")$value)/1000000,3))` maf)** – Based on Lake Mead Operating Condition of Level 1 Shortage and water savings contributions under the LB DCP Agreement and IBWC Minute 323.

#### U.S. Contractors: `r sprintf("%.3f",round(sum(apportionment[,3])/1000000,3))` maf

##### California: `r sprintf("%.3f",round(sum(apportionment[1,3])/1000000,3))` maf
* MWD annual diversion of `r round(as.numeric(find_rows_containing_string(sct_data,"MWDDiversionAnnualFC")[3])/1000,0)` kaf
    * Projected diversion includes the `r mwdICSY2` kaf of ICS
```{r generate-bullet-list-apply-2, results='asis'}
# Check if cons_CA_CY2 has rows and at least two columns before proceeding

if (nrow(cons_CA_CY2) > 0 && ncol(cons_CA_CY2) >= 2) {
  
  cat("* Total California System Conservation of ")
  cat(sprintf("%.1f",round(sum(cons_CA[,column_number+1])/1000,1)))
  cat(" kaf\n")

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_CA_CY2, 1, function(row) {
    paste0("  * ", row[1], " system conservation of ", round(as.numeric(row[2])/1000,1) , " kaf\n")
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} 

```

* Needles PSCP volume of `r as.numeric(find_rows_containing_string(Max2, "Needles")$value)*-1` af
```{r conditional-CA-BICS-Y2, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "AnnualCreationBiNat_MWD")[1,3]>0){
  addBICS = TRUE
  bics = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationBiNat_MWD")[1,3]/1000,1)))
} else{
  addBICS = FALSE
  bics=""
}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by MWD and IID\n")
}


```

##### Arizona: `r sprintf("%.3f",round(sum(apportionment[2,3])/1000000,3))` maf
* CAP annual diversion of `r round(find_rows_containing_string(sct_data, "CAPAnnualFC")[1,3]/1000,0)` kaf

```{r conditional-AZ-reductions-Y2, results='asis', echo=FALSE}

addreductions = calculate_AZ_reductions(year=2, sct_data = sct_data)$addreductions
reductions_scen_all = calculate_AZ_reductions(year=2, sct_data = sct_data)$reductions_scen_all

if (exists("addreductions") && addreductions) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("    * Projected diversion includes a ")
  cat(reductions_scen_all)
  cat("\n")
}

az_dcpICS <- find_rows_containing_string(sct_data, "AnnualCreationDCP_CAWCD")[3]
az_dcpICS <- ifelse((az_dcpICS/1000) %% 1 != 0, round(az_dcpICS/1000, 1), round(az_dcpICS/1000, 0))
az_dcpSys <- find_rows_containing_string(sct_data, "AnnualSysWaterforDCP_CAWCD")[3]
az_dcpSys <- ifelse((az_dcpSys/1000) %% 1 != 0, round(az_dcpSys/1000, 1), round(az_dcpSys/1000, 0))

```

* DCP contribution will be made by creating `r ifelse(az_dcpICS > 0, paste0(az_dcpICS, " kaf of ICS and ", az_dcpSys, " kaf of non-ICS water"), paste0(az_dcpSys, " kaf of non-ICS water"))` 
* Total non-CAWCD System Conservation of `r sprintf("%.1f",round(sum(cons_NonCAWCD_filt[,column_number +1])/1000,1))` kaf
```{r generate-bullet-list-nonCAWCD-Y2, results='asis'}
# Check if cons_CA_CY has rows and at least two columns before proceeding
if (nrow(cons_NonCAWCD_CY2) > 0 && ncol(cons_NonCAWCD_CY2) >= 2) {

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_NonCAWCD_CY2, 1, function(row) {
    paste0("  * ", row[1], " : ", ifelse(as.numeric(row[2])>100, paste0(round(as.numeric(row[2])/1000,1) , " kaf\n"), paste0(round(as.numeric(row[2]),0), " af\n") ))
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} 

```

* Total CAWCD System Conservation of `r sprintf("%.1f",round(sum(cons_CAWCD[,column_number +1])/1000,1))` kaf

```{r generate-bullet-list-CAWCD-Y2, results='asis'}
# Check if cons_CA_CY has rows and at least two columns before proceeding
if (nrow(cons_CAWCD_CY2) > 0 && ncol(cons_CAWCD_CY2) >= 2) {

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_CAWCD_CY2, 1, function(row) {
    paste0("  * ", row[1], " : ", ifelse(as.numeric(row[2])>100, paste0(round(as.numeric(row[2])/1000,1) , " kaf\n"), paste0(round(as.numeric(row[2]),0), " af\n") ))
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} 

```

* Bullhead City PSCP volume of `r as.numeric(find_rows_containing_string(Max2, "BHC")$value)*-1` af

```{r conditional-AZ-242-Y2, results='asis', echo=FALSE}

if(find_rows_containing_string(cons_NonCAWCD,"242 Wellfield")[,column_number+1]>0){
  add242 = TRUE
  vol242 = sprintf("%.1f",round(find_rows_containing_string(cons_NonCAWCD,"242 Wellfield")[,column_number+1]/1000,1))
} else{
  add242 = FALSE
  vol242=""
}

if (exists("add242") && add242) {
  
  cat("* System water created by the 242 Well Field Expansion Project of ")
  cat(vol242)
  cat(" kaf\n")
}

```


```{r conditional-AZ-BICS-Y2, results='asis', echo=FALSE}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by CAWCD\n")
}

```

##### Nevada: `r sprintf("%.3f",round(sum(apportionment[3,3])/1000000,3))` maf

* SNWA annual use of `r round(find_rows_containing_string(sct_data, "NvTotalAnnual")[1,3]/1000,0)` kaf. Projected diversion includes:

```{r conditional-NV-Shortage-Y2, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "SNWP Annual Shortage Volume")[1,3]>0){
  addNVShortage = TRUE
  nvshort = unlist(unname(round(find_rows_containing_string(sct_data, "SNWP Annual Shortage Volume")[1,3]/1000,0)))
} else{
  addNVShortage = FALSE
  nvshort=""
}

if(find_rows_containing_string(sct_data, "VacatedECICSToBeDelivered_SNWA")[1,3]>0){
  addECICSdel = TRUE
  nvECICSdel = unlist(unname(round(find_rows_containing_string(sct_data, "VacatedECICSToBeDelivered_SNWA")[1,3]/1000,1)))
} else{
  addECICSdel = FALSE
  nvECICSdel=""
}

if (exists("addNVShortage") && addNVShortage) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Shortage volume of ")
  cat(nvshort)
  cat(" kaf\n")
}

if (exists("addECICSdel") && addECICSdel) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Delivery of ")
  cat(nvECICSdel)
  cat(" kaf of EC ICS due to full ICS bank\n")
}

```


```{r conditional-NV-DCP-Y2, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "AnnualCreationDCP_NV")[1,3]>0){
  addNVDCP = TRUE
  nvdcp = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationDCP_NV")[1,3]/1000,0)))
} else{
  addNVDCP = FALSE
  nvdcp=""
}

if (exists("addNVDCP") && addNVDCP) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("* DCP contribution of ")
  cat(nvdcp)
  cat(" kaf through EC ICS conversion\n")
}


```


```{r conditional-NV-SysCons-Y2, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "NV_SystemConservation")[1,3]>0){
  addNVTotSyscon = TRUE
  nvTotSyscon = unlist(unname(round(find_rows_containing_string(sct_data, "NV_SystemConservation")[1,3]/1000,0)))
} else{
  addNVTotSyscon = FALSE
  nvTotSyscon=""
}

if(find_rows_containing_string(sct_data, "NV_LeftinMead")[1,3]>0){
  addTribSyscon = TRUE
  nvTribSyscon = unlist(unname(round(find_rows_containing_string(sct_data, "NV_LeftinMead")[1,3]/1000,0)))
} else{
  addTribSyscon = FALSE
  nvTribSyscon=""
}


if (exists("addNVTotSyscon") && addNVTotSyscon) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("* Total System Conservation of ")
  cat(nvTotSyscon)
  cat(" kaf\n")
}

if (exists("addTribSyscon") && addTribSyscon) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Tributary conservation of ")
  cat(nvTribSyscon)
  cat(" kaf\n")
}

if(addNVTotSyscon && addTribSyscon) {
  if((nvTotSyscon - nvTribSyscon)>0){
    cat("  * Other system conservation of ")
    cat(nvTotSyscon - nvTribSyscon)
    cat(" kaf\n")
  }
}


```

```{r conditional-NV-BICS-Y2, results='asis', echo=FALSE}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by SNWA\n")
}

```


#### Mexico’s Scheduled Water Delivery: `r sprintf("%.3f", round(as.numeric(find_rows_containing_string(Max2, "Mexico Use")$value)/1000000,3))` maf

```{r conditional-Mx-short-Y2, results='asis', echo=FALSE}
# This R code chunk will print Markdown text if the condition is met.
# The 'results="asis"' option is crucial for this to work.

if(find_rows_containing_string(sct_data, "Mexico Annual Shortage")[1,3]>0){
  addMxShort = TRUE
  mxShort = unlist(unname(round(find_rows_containing_string(sct_data, "Mexico Annual Shortage")[1,3]/1000,0)))
} else{
  addMxShort = FALSE
  mxShort=""
}

if(find_rows_containing_string(sct_data, "AnnualCreationMXRecoverableWaterSavings")[1,3]>0){
  createWaterSav = TRUE
  mxCreateWaterSav = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationMXRecoverableWaterSavings")[1,3]/1000,0)))
} else{
  createWaterSav = FALSE
  mxCreateWaterSav=""
}

if(find_rows_containing_string(sct_data, "AnnualDeliveryMXRecoverableWaterSavings")[1,3]>0){
  delWaterSav = TRUE
  mxdelWaterSav = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualDeliveryMXRecoverableWaterSavings")[1,3]/1000,0)))
} else{
  delWaterSav = FALSE
  mxdelWaterSav=""
}

if(find_rows_containing_string(sct_data, "MX_SystemConservation")[1,3]>0){
  createsysCons = TRUE
  mxSysCon = unlist(unname(round(find_rows_containing_string(sct_data, "MX_SystemConservation")[1,3]/1000,1)))
} else{
  createsysCons = FALSE
  mxSysCon=""
}

if(find_rows_containing_string(sct_data, "AnnualDeliveryMexicoWaterReserve")[1,3]>0){
  delMWR = TRUE
  mxdelMWR = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualDeliveryMexicoWaterReserve")[1,3]/1000,1)))
} else{
  delMWR = FALSE
  mxdelMWR=""
}

if(find_rows_containing_string(sct_data, "AnnualCreationMexicoWaterReserve")[1,3]>0){
  createMWR = TRUE
  mxcreateMWR = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationMexicoWaterReserve")[1,3]/1000,1)))
} else{
  createMWR = FALSE
  mxcreateMWR=""
}

if (exists("createWaterSav") && createWaterSav) {
  cat("* Projected delivery includes:\n")
  
  if (exists("addMxShort") && addMxShort) {
    cat("  * Shortage volume of ")
    cat(mxShort)
    cat(" kaf\n")
  }
  
  cat("  * Recoverable Water Savings Contribution of ")
  cat(mxCreateWaterSav)
  cat(" kaf\n")
  
  if (exists("delWaterSav") && delWaterSav) {
    cat("  * Recoverable Water Savings Delivery of ")
    cat(mxdelWaterSav)
    cat(" kaf\n")
  }
  
  if (exists("createsysCons") && createsysCons) {
    cat("  * Minute 330 System Conservation of ")
    cat(mxSysCon)
    cat(" kaf\n")
  }
  
  if (exists("delMWR") && delMWR) {
    cat("* Water Reserve delivery of ")
    cat(mxdelMWR)
    cat(" kaf\n")
  }
  
  if (exists("createMWR") && createMWR) {
    cat("* Water Reserve creation of ")
    cat(mxcreateMWR)
    cat(" kaf\n")
  }
}

```


### `r as.numeric(current_year) + 2`

Total projected water use **(`r sprintf("%.3f",round(as.numeric(find_rows_containing_string(Max3,"Total Basin Use")$value)/1000000,3))` maf)** – Based on Lake Mead Operating Condition of Level 2 Shortage and water savings contributions under the LB DCP Agreement and IBWC Minute 323. For modeling purposes, simulated years beyond 2026 assume a continuation of the 2007 Interim Guidelines, the 2019 Colorado River Basin Drought Contingency Plans, and Minute 323, including the Binational Water Scarcity Contingency Plan. Except for certain provisions related to ICS recovery and Upper Basin demand management, operations under these agreements are in effect through 2026. Reclamation initiated the process to develop operations for post-2026 in June 2023, and the modeling assumptions described here are subject to change.

#### U.S. Contractors: `r sprintf("%.3f",round(sum(apportionment[,4])/1000000,3))` maf

##### California: `r sprintf("%.3f",round(sum(apportionment[1,4])/1000000,3))` maf
* MWD annual diversion of `r round(as.numeric(find_rows_containing_string(sct_data,"MWDDiversionAnnualFC")[4])/1000,0)` kaf
    * Projected diversion includes the `r mwdICSY3` kaf of ICS
    
```{r generate-bullet-list-apply-3, results='asis'}
# Check if cons_CA_CY3 has rows and at least two columns before proceeding

if (nrow(cons_CA_CY3) > 0 && ncol(cons_CA_CY3) >= 2) {
  
  cat("* Total California System Conservation of ")
  cat(sprintf("%.1f",round(sum(cons_CA[,column_number+2])/1000,1)))
  cat(" kaf\n")

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_CA_CY3, 1, function(row) {
    paste0("  * ", row[1], " system conservation of ", round(as.numeric(row[2])/1000,1) , " kaf\n")
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} 

```

* Needles PSCP volume of `r as.numeric(find_rows_containing_string(Max3, "Needles")$value)*-1` af

```{r conditional-CA-BICS-Y3, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "AnnualCreationBiNat_MWD")[1,4]>0){
  addBICS = TRUE
  bics = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationBiNat_MWD")[1,4]/1000,1)))
} else{
  addBICS = FALSE
  bics=""
}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by MWD and IID\n")
}


```

##### Arizona: `r sprintf("%.3f",round(sum(apportionment[2,4])/1000000,3))` maf
* CAP annual diversion of `r prettyNum(round(find_rows_containing_string(sct_data, "CAPAnnualFC")[1,4]/1000,0),  big.mark = ",", scientific = FALSE)` kaf
```{r conditional-AZ-reductions-Y3, results='asis', echo=FALSE}

addreductions = calculate_AZ_reductions(year=3, sct_data = sct_data)$addreductions
reductions_scen_all = calculate_AZ_reductions(year=3, sct_data = sct_data)$reductions_scen_all

if (exists("addreductions") && addreductions) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("    * Projected diversion includes a ")
  cat(reductions_scen_all)
  cat("\n")
}

az_dcpICS <- find_rows_containing_string(sct_data, "AnnualCreationDCP_CAWCD")[4]
az_dcpICS <- ifelse((az_dcpICS/1000) %% 1 != 0, round(az_dcpICS/1000, 1), round(az_dcpICS/1000, 0))
az_dcpSys <- find_rows_containing_string(sct_data, "AnnualSysWaterforDCP_CAWCD")[4]
az_dcpSys <- ifelse((az_dcpSys/1000) %% 1 != 0, round(az_dcpSys/1000, 1), round(az_dcpSys/1000, 0))

```

* DCP contribution will be made by creating `r ifelse(az_dcpICS > 0, paste0(az_dcpICS, " kaf of ICS and ", az_dcpSys, " kaf of non-ICS water"), paste0(az_dcpSys, " kaf of non-ICS water"))` 
* Total non-CAWCD System Conservation of `r sprintf("%.1f",round(sum(cons_NonCAWCD_filt[,column_number +2])/1000,1))` kaf
```{r generate-bullet-list-nonCAWCD-Y3, results='asis'}
# Check if cons_CA_CY3 has rows and at least two columns before proceeding
if (nrow(cons_NonCAWCD_CY3) > 0 && ncol(cons_NonCAWCD_CY3) >= 2) {

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_NonCAWCD_CY3, 1, function(row) {
    paste0("  * ", row[1], " : ", ifelse(as.numeric(row[2])>100, paste0(round(as.numeric(row[2])/1000,1) , " kaf\n"), paste0(round(as.numeric(row[2]),0), " af\n") ))
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} 

```

* Total CAWCD System Conservation of `r sprintf("%.1f",round(sum(cons_CAWCD[,column_number +2])/1000,1))` kaf

```{r generate-bullet-list-CAWCD-Y3, results='asis'}
# Check if cons_CA_CY3 has rows and at least two columns before proceeding
if (nrow(cons_CAWCD_CY3) > 0 && ncol(cons_CAWCD_CY3) >= 2) {

  # Use apply to iterate over rows. For each row:
  # row[1] will be the value from the first column of cons_CA_CY
  # row[2] will be the value from the second column of cons_CA_CY
  bullet_points <- apply(cons_CAWCD_CY3, 1, function(row) {
    paste0("  * ", row[1], " : ", ifelse(as.numeric(row[2])>100, paste0(round(as.numeric(row[2])/1000,1) , " kaf\n"), paste0(round(as.numeric(row[2]),0), " af\n") ))
  })
  
  # Print each bullet point, separated by a newline
  cat(paste0(bullet_points, collapse = ""))
  
} 

```

* Bullhead City PSCP volume of `r as.numeric(find_rows_containing_string(Max3, "BHC")$value)*-1` af

```{r conditional-AZ-242-Y3, results='asis', echo=FALSE}

if(find_rows_containing_string(cons_NonCAWCD,"242 Wellfield")[,column_number+2]>0){
  add242 = TRUE
  vol242 = sprintf("%.1f",round(find_rows_containing_string(cons_NonCAWCD,"242 Wellfield")[,column_number+2]/1000,1))
} else{
  add242 = FALSE
  vol242=""
}

if (exists("add242") && add242) {
  
  cat("* System water created by the 242 Well Field Expansion Project of ")
  cat(vol242)
  cat(" kaf\n")
}

```


```{r conditional-AZ-BICS-Y3, results='asis', echo=FALSE}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by CAWCD\n")
}

```


##### Nevada: `r sprintf("%.3f",round(sum(apportionment[3,4])/1000000,3))` maf

* SNWA annual use of `r round(find_rows_containing_string(sct_data, "NvTotalAnnual")[1,4]/1000,0)` kaf. Projected diversion includes:

```{r conditional-NV-Shortage-Y3, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "SNWP Annual Shortage Volume")[1,4]>0){
  addNVShortage = TRUE
  nvshort = unlist(unname(round(find_rows_containing_string(sct_data, "SNWP Annual Shortage Volume")[1,4]/1000,0)))
} else{
  addNVShortage = FALSE
  nvshort=""
}

if(find_rows_containing_string(sct_data, "VacatedECICSToBeDelivered_SNWA")[1,4]>0){
  addECICSdel = TRUE
  nvECICSdel = unlist(unname(round(find_rows_containing_string(sct_data, "VacatedECICSToBeDelivered_SNWA")[1,4]/1000,1)))
} else{
  addECICSdel = FALSE
  nvECICSdel=""
}

if (exists("addNVShortage") && addNVShortage) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Shortage volume of ")
  cat(nvshort)
  cat(" kaf\n")
}

if (exists("addECICSdel") && addECICSdel) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Delivery of ")
  cat(nvECICSdel)
  cat(" kaf of EC ICS due to full ICS bank\n")
}

```


```{r conditional-NV-DCP-Y3, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "AnnualCreationDCP_NV")[1,4]>0){
  addNVDCP = TRUE
  nvdcp = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationDCP_NV")[1,4]/1000,0)))
} else{
  addNVDCP = FALSE
  nvdcp=""
}

if (exists("addNVDCP") && addNVDCP) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("* DCP contribution of ")
  cat(nvdcp)
  cat(" kaf through EC ICS conversion\n")
}


```


```{r conditional-NV-SysCons-Y3, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "NV_SystemConservation")[1,4]>0){
  addNVTotSyscon = TRUE
  nvTotSyscon = unlist(unname(round(find_rows_containing_string(sct_data, "NV_SystemConservation")[1,4]/1000,0)))
} else{
  addNVTotSyscon = FALSE
  nvTotSyscon=""
}

if(find_rows_containing_string(sct_data, "NV_LeftinMead")[1,4]>0){
  addTribSyscon = TRUE
  nvTribSyscon = unlist(unname(round(find_rows_containing_string(sct_data, "NV_LeftinMead")[1,4]/1000,0)))
} else{
  addTribSyscon = FALSE
  nvTribSyscon=""
}


if (exists("addNVTotSyscon") && addNVTotSyscon) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("* Total System Conservation of ")
  cat(nvTotSyscon)
  cat(" kaf\n")
}

if (exists("addTribSyscon") && addTribSyscon) {
  #cat("\n") # Ensures a new line before the conditional text
  cat("  * Tributary conservation of ")
  cat(nvTribSyscon)
  cat(" kaf\n")
}

if(addNVTotSyscon && addTribSyscon) {
  if((nvTotSyscon - nvTribSyscon)>0){
    cat("  * Other system conservation of ")
    cat(nvTotSyscon - nvTribSyscon)
    cat(" kaf\n")
  }
}


```

```{r conditional-NV-BICS-Y3, results='asis', echo=FALSE}

if (exists("addBICS") && addBICS) {
  
  cat("* Binational ICS creation of ")
  cat(bics)
  cat(" kaf by SNWA\n")
}

```



#### Mexico’s Scheduled Water Delivery: `r sprintf("%.3f", round(as.numeric(find_rows_containing_string(Max3, "Mexico Use")$value)/1000000,3))` maf

```{r conditional-Mx-short-Y3, results='asis', echo=FALSE}

if(find_rows_containing_string(sct_data, "Mexico Annual Shortage")[1,4]>0){
  addMxShort = TRUE
  mxShort = unlist(unname(round(find_rows_containing_string(sct_data, "Mexico Annual Shortage")[1,4]/1000,0)))
} else{
  addMxShort = FALSE
  mxShort=""
}

if(find_rows_containing_string(sct_data, "AnnualCreationMXRecoverableWaterSavings")[1,4]>0){
  createWaterSav = TRUE
  mxCreateWaterSav = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationMXRecoverableWaterSavings")[1,4]/1000,0)))
} else{
  createWaterSav = FALSE
  mxCreateWaterSav=""
}

if(find_rows_containing_string(sct_data, "AnnualDeliveryMXRecoverableWaterSavings")[1,4]>0){
  delWaterSav = TRUE
  mxdelWaterSav = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualDeliveryMXRecoverableWaterSavings")[1,4]/1000,0)))
} else{
  delWaterSav = FALSE
  mxdelWaterSav=""
}

if(find_rows_containing_string(sct_data, "MX_SystemConservation")[1,4]>0){
  createsysCons = TRUE
  mxSysCon = unlist(unname(round(find_rows_containing_string(sct_data, "MX_SystemConservation")[1,4]/1000,1)))
} else{
  createsysCons = FALSE
  mxSysCon=""
}

if(find_rows_containing_string(sct_data, "AnnualDeliveryMexicoWaterReserve")[1,4]>0){
  delMWR = TRUE
  mxdelMWR = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualDeliveryMexicoWaterReserve")[1,4]/1000,1)))
} else{
  delMWR = FALSE
  mxdelMWR=""
}

if(find_rows_containing_string(sct_data, "AnnualCreationMexicoWaterReserve")[1,4]>0){
  createMWR = TRUE
  mxcreateMWR = unlist(unname(round(find_rows_containing_string(sct_data, "AnnualCreationMexicoWaterReserve")[1,4]/1000,1)))
} else{
  createMWR = FALSE
  mxcreateMWR=""
}

if (exists("createWaterSav") && createWaterSav) {
  cat("* Projected delivery includes:\n")
  
  if (exists("addMxShort") && addMxShort) {
    cat("  * Shortage volume of ")
    cat(mxShort)
    cat(" kaf\n")
  }
  
  cat("  * Recoverable Water Savings Contribution of ")
  cat(mxCreateWaterSav)
  cat(" kaf\n")
  
  if (exists("delWaterSav") && delWaterSav) {
    cat("  * Recoverable Water Savings Delivery of ")
    cat(mxdelWaterSav)
    cat(" kaf\n")
  }
  
  if (exists("createsysCons") && createsysCons) {
    cat("  * Minute 330 System Conservation of ")
    cat(mxSysCon)
    cat(" kaf\n")
  }
  
  if (exists("delMWR") && delMWR) {
    cat("* Water Reserve delivery of ")
    cat(mxdelMWR)
    cat(" kaf\n")
  }
  
  if (exists("createMWR") && createMWR) {
    cat("* Water Reserve creation of ")
    cat(mxcreateMWR)
    cat(" kaf\n")
  }
}

```


### ICS Totals

* Projected ICS Total Storage at the end of CY 2027: **2.687 maf**
* Projected ICS Storage Balances at the end of each calendar year in the study are as follows:

| State | 2025      | 2026      | 2027      |
|-------|-----------|-----------|-----------|
| AZ    | 616,332   | 683,215   | 648,710   |
| CA    | 1,440,291 | 1,447,504 | 1,442,626 |
| NV    | 498,522   | 516,704   | 595,904   |
| Total | 2,555,145 | 2,647,423 | 2,687,240 |

#### ICS Totals Table (Formatted with R)

Here's an example of how you could create the ICS Totals table using an R code chunk with the `knitr` package for a nicer output.

```{r ics-table}
# The global options echo=FALSE, warning=FALSE, message=FALSE from the setup chunk will apply here
# Load the knitr package if you haven't in the setup chunk
if (!requireNamespace("knitr", quietly = TRUE)) {
  install.packages("knitr")
}
library(knitr)

# Create a data frame for the ICS Totals
ics_data <- data.frame(
  State = c("AZ", "CA", "NV", "Total"),
  `2025` = c(616332, 1440291, 498522, 2555145),
  `2026` = c(683215, 1447504, 516704, 2647423),
  `2027` = c(648710, 1442626, 595904, 2687240)
)

# Print the table using kable
# For docx output, kable will automatically choose an appropriate format.
# The 'format = "pipe"' is more for Markdown/HTML.
# We can let kable decide or explicitly use 'format = "pandoc"' or 'format = "simple"' for wider compatibility if needed.
kable(ics_data, caption = "Projected ICS Storage Balances (kaf)", col.names = c("State", "2025 (kaf)", "2026 (kaf)", "2027 (kaf)"))
```

## Notes and Disclaimers

* Modeled Conservation volumes reflect executed agreements and/or current operational projections/assumptions and are subject to change. Additional conservation activities are being considered. After new agreements are finalized and executed, these additional activities will be included in Reclamation’s operational modeling.
* Projected SEIS ROD Reservoir Protection Volume is 3.631 from 2023 through 2026.

